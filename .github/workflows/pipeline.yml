name: Pipeline de Testes de Contrato

on: [push]

jobs:
  executar-testes:
    runs-on: ubuntu-latest

    services:
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics check_running"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Baixar codigo do repositorio
        uses: actions/checkout@v4

      - name: Instalar o Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar bibliotecas e Plugin de Relatorio
        run: |
          pip install pika jsonschema pytest pytest-html

      - name: Simular envio de mensagem (Produtor)
        run: python produtor.py

      - name: Rodar Testes e Gerar HTML
        run: pytest test_rabbitmq_contrato.py --html=relatorio_testes.html --self-contained-html

      - name: Anexar Relatorio no GitHub Actions
        if: always() # Garante que o relat√≥rio seja gerado mesmo se o teste falhar
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-de-testes-contrato
          path: relatorio_testes.html